<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!--css-->
    <link rel="stylesheet" href="css/diary.css?v=v=5.9.5">
    <!--js-->
<!--    <script src="js/vue_2.66.js"></script> &lt;!&ndash;develop&ndash;&gt;-->
    <script src="js/vue.min.2.6.10.js"></script> <!--production-->
    <script src="js/jquery-2.2.4.min.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/diary.js?v=v=5.9.5"></script>

    <link rel="shortcut icon" href="img/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="img/appicon-apple.png">

    <title>æ—¥è®°</title>
</head>
<body class="body-normal">

<nav class="navbar clearfix" id="navbar">
    <div class="navbar-btn-group left">
        <img v-show="btnMenu" @click="showMenu" src="img/tabicon/menu.svg" alt="èœå•">
        <img v-show="btnClose" @click="closeMenu" src="img/tabicon/close.svg" alt="å…³é—­">
    </div>
    <div class="navbar-btn-group right">
        <img v-show="btnAdd" @click="addClicked" src="img/tabicon/add.svg" alt="æ·»åŠ ">
        <img v-show="btnConfirm" @click="confirmClicked" src="img/tabicon/done.svg" alt="æ·»åŠ ">
    </div>
    <div class="brand">
        <a href="index.html"><img src="img/logo_content.svg?v=v=5.9.5" alt="æ—¥è®°"></a>
    </div>
</nav>

<!--MENU-->
<div class="menu-panel" id="menu-panel" v-show="menuPanelShowed" style="display: none;">
    <div class="menu-list-group" v-show="menuListShowed">
        <a class="menu-list-group-item" @click="showSearchBar">æœç´¢</a>
        <a class="menu-list-group-item" @click="referenceClicked">ç±»åˆ«</a>
        <a class="menu-list-group-item" @click="aboutClicked">å…³äº</a>
        <a class="menu-list-group-item" href="change_password.html">ä¿®æ”¹å¯†ç </a>
        <a class="menu-list-group-item" @click="logout">é€€å‡º</a>
        <div class="user-info">
            <span class="username">{{userInfo.username}}</span>
            <span class="email">{{userInfo.email}}</span>
        </div>
    </div>

    <!--reference-->
    <ul class="reference" v-show="referenceShowed" style="display: none;">


        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-game" value="game"><label class="reference-game" for="category-game">æ¸¸æˆ</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-study" value="study"><label class="reference-study" for="category-study">å­¦ä¹ </label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-work" value="work"><label class="reference-work" for="category-work">å·¥ä½œ</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-sport" value="sport"><label class="reference-sport" for="category-sport">è¿åŠ¨</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-week" value="week"><label class="reference-week" for="category-week">å‘¨æŠ¥</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-life" value="life"><label class="reference-life" for="category-life">ç”Ÿæ´»</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-film" value="film"><label class="reference-film" for="category-film">ç”µå½±</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-bigevent" value="bigevent"><label class="reference-bigevent" for="category-bigevent">å¤§äº‹</label></li>
        <li class="list-group-item"><input v-model="categories" class="hidden" type="checkbox" id="category-article" value="article"><label class="reference-article" for="category-article">æ–‡ç« </label></li>

        <li class="list-group-item toggle-btn"><input :checked="showSelectAllBtn" @click="toggleCategorySelect" class="hidden" type="checkbox" id="category-all"><label for="category-all" class="reference-all">{{ showSelectAllBtn? 'å…¨é€‰': 'å…¨ä¸é€‰' }}</label></li>
        <li class="list-group-item toggle-btn"><input checked @click="reverseCategorySelect" class="hidden" type="checkbox" id="category-reverse"><label for="category-reverse" class="reference-all">åé€‰</label></li>


    </ul>


    <!--about-->
    <div class="about" v-show="aboutShowed" style="display: none;">
        <h3 class="title">æ ‡é¢˜æ—¥è®°</h3>
        <h4 class="subtitle">ç”¨ä¸€å¥è¯è®°å½•ä½ æœ€çè´µçš„æ—¶åˆ»</h4>
        <div class="author">
            <a href="http://kylebing.cn" class="social-link">ğŸŒ–å¼€å‘è€…ä¸»é¡µ</a>
            <a href="http://weibo.com/kylebing" class="social-link">@åæœˆooOO</a>
            <a href="mailto:kylebing@163.com">kylebing@163.com</a>
        </div>
    </div>
    <!--search-->

</div>

<script>

  // Navbar
  let navbar = new Vue({
    el:"#navbar",
    data:{
      btnClose: false,
      btnMenu: true,
      btnAdd: true,
      btnConfirm: false
    },
    methods:{

      showMenu: function () {
        this.btnClose = true;
        this.btnMenu = false;
        // this.btnAdd = false;
        menu.menuPanelShowed = true;
      },
      closeMenu: function () {
        if (menu.secondMenuShowed){
          if (menu.referenceShowed){  // å»æ‰è¿™ä¸ªæ¡ä»¶æ¢å¤æ­£å¸¸æ¨¡å¼ï¼Œç°åœ¨æ˜¯ä» reference ç›´æ¥è¿› index åˆ—è¡¨
            menu.menuListShowed = true;
            menu.secondMenuShowed = false;
            menu.referenceShowed = false;
            this.btnClose = false;
            this.btnMenu = true;
            this.btnAdd = true;
            menu.menuPanelShowed = false;
          }
          menu.menuListShowed = true;
          menu.secondMenuShowed = false;
        } else {
          this.btnClose = false;
          this.btnMenu = true;
          this.btnAdd = true;
          menu.menuPanelShowed = false;
        }

      },
      addClicked: function () {
        location = FrontURL.edit;
      },
      confirmClicked: function () {
      }
    }
  });

  // MenuPanel
  let menu = new Vue({
    el: "#menu-panel",
    data:{
      menuPanelShowed:    false,      // menu panel
      secondMenuShowed:   false,      // second menu
      menuListShowed:     true,       // menu list
      referenceShowed:    false,      // reference
      aboutShowed:        false,      // about
      userInfo: getAuthorization(),
      categories: []
    },
    watch:{
      secondMenuShowed: function () { // false all second panel when secondMenuShowed is false.
        if (!this.secondMenuShowed){
          this.referenceShowed = false;
          this.aboutShowed = false;
        }
      },
      menuPanelShowed: function () {
        if(this.menuPanelShowed){
          navbar.btnAdd = false;
        }
      },
      referenceShowed: function () {
        // console.log(this.categories);
        $.cookie(COOKIE.category,JSON.stringify(this.categories), COOKIE.options);
        diaryApp.freshLoad(); // å…³é—­ reference é¡µé¢çš„æ—¶å€™åˆå§‹åŒ–è½½å…¥å†…å®¹
      }

    },
    methods: {
      toggleCategorySelect: function () {
        if (this.categories.length) {
          this.categories = [];
        } else {
          this.categories = AllCategories
        }
      },
      reverseCategorySelect: function () {
        let tempCategories = [].concat(AllCategories);
        this.categories.forEach(item => {
          tempCategories.splice(tempCategories.indexOf(item), 1)
        });
        this.categories = tempCategories;
      },
      referenceClicked: function () {
        this.menuListShowed = false;
        this.menuPanelShowed = true;
        this.secondMenuShowed = true;
        this.referenceShowed = true;
      },
      aboutClicked: function () {
        this.menuListShowed = false;
        this.menuPanelShowed = true;
        this.secondMenuShowed = true;
        this.aboutShowed = true;
      },
      showSearchBar: function () {
        diaryApp.searchBarShow = true;
        navbar.closeMenu();
        document.scrollingElement.scrollTo(0, 0); // å®šä½åˆ°æœ€ä¸Šæ–¹
        $('#keyword').focus();
      },
      logout: function () {
        deleteAuthorization();
        $.removeCookie(COOKIE.category, {path: '/'});
        location = FrontURL.login;
      },
      refreshContent: function () {
        diaryApp.freshLoad();
      }
    },
    computed: {
      // å…¨é€‰æŒ‰é’®éšç±»åˆ«æ•°ç»„å˜åŒ–è€Œå˜åŒ–
      showSelectAllBtn: function () {
        return !this.categories.length
      }
    },
    created: function () {
      this.categories = JSON.parse($.cookie(COOKIE.category));
    }
  });
</script>


<div class="container" id="diaryApp">
    <div class="search-bar" v-show="searchBarShow">
        <form @submit.prevent="searchConfirmed">
            <input id="keyword" type="text" placeholder="æœç´¢å†…å®¹" v-model="keyword">
            <span v-show="keyword.length > 0" @click="freshLoad" class="clear">âœ•</span>
        </form>
    </div>
    <div class="diary-list-group">
    </div>

    <!--åŠ è½½åŠ¨ç”»-->
    <div v-show="isLoading" class="loading">
        <div class="loading-1 loading-item"></div>
        <div class="loading-2 loading-item"></div>
        <div class="loading-3 loading-item"></div>
    </div>

    <div v-show="!isLoading&&!haveMore" class="end-of-diary">
        <p><img src="img/EOF.svg" alt="EOF"></p>
    </div>
</div>


<script>

    const WEATHER = {
        sunny: {title: 'sunny', name: 'æ™´'},
        cloudy: {title: 'cloudy', name: 'å¤šäº‘'},
        overcast: {title: 'overcast', name: 'é˜´'},
        sprinkle: {title: 'sprinkle', name: 'å°é›¨'},
        rain: {title: 'rain', name: 'é›¨'},
        thunderstorm: {title: 'thunderstorm', name: 'æš´é›¨'},
        snow: {title: 'snow', name: 'é›ª'},
        fog: {title: 'fog', name: 'é›¾'}
    };
    const CATEGORIES = {
      life: 'ç”Ÿæ´»',
      study: 'å­¦ä¹ ',
      work: 'å·¥ä½œ',
      sport: 'è¿åŠ¨',
      game: 'æ¸¸æˆ',
      film: 'ç”µå½±',
      bigevent: 'å¤§äº‹',
      week: 'å‘¨æŠ¥',
      article: 'æ–‡ç« ',
    };

    let pageNo = 1;
    let PAGE_AMOUNT = 50;

    window.onload = () => {
        // æ»šåŠ¨ç›‘å¬
        addScrollEvent();
    };

    function addScrollEvent() {
        window.onscroll = () => {
            if (diaryApp.haveMore && needLoadContent()){
                diaryApp.loadMore();
            }
        };
    }

    // åˆ¤æ–­æ˜¯å¦åŠ è½½å†…å®¹
    function needLoadContent() {
        let lastOffsetTop = document.querySelector('.article:last-child .article-body').offsetTop;
        let clientHeight = window.innerHeight;
        let scrollTop = document.scrollingElement.scrollTop;
        // console.clear();
        // console.log(`${lastOffsetTop} | ${clientHeight} | ${scrollTop}`);
        return (lastOffsetTop < clientHeight + scrollTop);
    }

    function getDiaries(queryData) {
        if (getAuthorization()){
            $.ajax({
                data:queryData,
                url:URL.diaryOperation,
                dataType:'json',
                method:"GET",
                success:onSuccess,
                error:(xhr) => {
                    console.log(xhr);
                }
            });
            function onSuccess(data) {
                diaryApp.isLoading = false;
                if(data.success){ // æˆåŠŸè·å–æ•°æ®
                    // åˆ·æ–° cookie è¿‡æœŸæ—¶é—´
                    setAuthorization(getAuthorization().email, getAuthorization().token, getAuthorization().username, getAuthorization().uid);
                    $.cookie(COOKIE.category, $.cookie(COOKIE.category), COOKIE.options);

                    diaryApp.diaries = diaryApp.diaries.concat(data.data);
                    // åœ¨åé¢åˆ¤æ–­è·å–çš„æ•°æ®ï¼Œå°äº1æˆ–å°äºæ¯é¡µçš„æ•°é‡æ—¶ï¼Œéšè—åŠ è½½æ›´å¤šæŒ‰é’®
                    diaryApp.haveMore = !(data.data.length < PAGE_AMOUNT);
                    if (!diaryApp.haveMore){
                        window.onscroll = null; // æ—¥è®°å…¨éƒ¨åŠ è½½å®Œæ¯•åï¼Œå»æ‰ scroll äº‹ä»¶
                    }
                    pageNo++;
                } else if (!data.logined){ // æœªç™»å½•
                    popMessage(PopMessageType.warning, data.info,()=>{
                        location = FrontURL.login;
                    })
                } else { // å…¶å®ƒæƒ…å†µ
                    popMessage(PopMessageType.danger, data.info);
                    diaryApp.haveMore = true
                }
            }
        }
    }



    // Diary
    let diaryApp = new Vue({
        el: "#diaryApp",
        data: {
            searchBarShow: false,
            haveMore: true,
            isLoading: true,
            diaries: [],
            keyword: '',
        },
        mounted: function () {
            // init
            this.keyword =  $.cookie(COOKIE.keyword)?  $.cookie(COOKIE.keyword): '';
            this.loadMore();
        },
        watch:{
            diaries: function () {
                diaries = this.diaries;
                if (diaries.length > 0) {{
                    let html = '';
                    diaries.forEach(item => {
                        let contentHtml = '';
                        if(item.content){
                            contentHtml = `<div class="content">
                                                ${item.content.replace(/\n/g, '<br/>')}
                                            </div>`
                        }
                        let template = `<div  class="article">
                                            <a href="detail.html?diaryId=${item.id}" class="article-header category-bg-${item.category}">
                                                <div class="week">${formateDate(item.date).weekday}</div>
                                                <div class="date">${formateDate(item.date).date}</div>
                                                <div class="category text-${item.category}">${CATEGORIES[item.category]}</div>
                                            </a>
                                            <div class="article-body">
                                                <div class="title">${item.title}</div>
                                                ${contentHtml}
                                            </div>
                                        </div>`;
                        html += template;
                    });
                    html+=`</div>`;
                    document.querySelector('.diary-list-group').innerHTML = html;
                }} else {
                    document.querySelector('.diary-list-group').innerHTML = ''
                }
            }
        },
        methods:{
            loadMore: function () {
                this.searchBarShow = !!this.keyword;
                this.haveMore = false;
                this.isLoading = true;
                let queryData = {
                    "keyword": this.keyword,
                    "pageCount": PAGE_AMOUNT,
                    "pageNo": pageNo,
                    "type": "list",
                    "category": menu.categories
                };
                getDiaries(queryData)
            },
            freshLoad: function () {
                pageNo = 1;
                diaryApp.diaries = [];
                this.keyword = '';
                $.cookie(COOKIE.keyword, this.keyword, COOKIE.options);
                this.loadMore();
            },
            searchConfirmed: function () {
                window.onscroll = null; // å»æ‰ç°æœ‰scroll
                addScrollEvent();       // æ·»åŠ  scroll äº‹ä»¶
                // åˆå§‹åŒ–ä¸€äº›å€¼
                pageNo = 1;
                diaryApp.diaries = [];
                this.loadMore();
                // å­˜å‚¨å…³é”®å­—
                $.cookie(COOKIE.keyword, this.keyword, COOKIE.options)
            },

        }
    });

    // logo ç‚¹å‡»åˆ‡æ¢å›¾æ ‡
    function toggleLogo(logo) {
        const LOGO = {
            open: 'img/logo.svg',
            close: 'img/logo_close.svg'
        };
        let img = $(logo).children('img');
        let currentSrc = img.attr('src');
        if (currentSrc === LOGO.open){
            img.attr('src', LOGO.close);
            $('.list-content').slideUp()
        } else {
            img.attr('src', LOGO.open);
            $('.list-content').slideDown()
        }
    }

    function toggleMonthContent(header){
        $(header).next().slideToggle();
    }


    function formateDate(dateString){
        let year = Number(dateString.substring(0,4));
        let month = Number(dateString.substring(5,7));
        let day = Number(dateString.substring(8,10));
        let date = new Date(year, month - 1, day);
        let week = date.getDay();
        return {
            weekday: WEEKDAY[week],
            date:`${year}å¹´${month}æœˆ${day}æ—¥`
        }
    }

</script>
</body>
</html>
